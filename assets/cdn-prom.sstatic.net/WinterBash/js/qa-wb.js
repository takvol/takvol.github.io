window.WinterBash=window.WinterBash||{},window.WinterBash.core=function(){function e(e,a,o){M=e,window.WinterBash.STATIC_CONTENT_ROOT=P=a,WinterBash.IMAGE_CACHE_BREAKER=o||"0",Y=WinterBash.text.getGetText(StackExchange.options.locale),$.when(l(),u()).done(function(e){StackExchange.options.user.isAnonymous||i(e),(StackExchange.options.user.isAnonymous||e)&&t(function(){h(),m(),$(window).on("resize",V.trigger),$(window).on("storage",function(e){e.originalEvent.key===L+"wearing"&&V.trigger()}),$(document).on("click",".new-post-activity, .account-toggle",V.trigger),n(),setTimeout(E,50),/^\/users\/-?\d+/i.test(location.pathname)&&j(),"/review"===location.pathname&&setInterval(function(){V.trigger(!0)},3e3)})})}function t(e){WinterBash.hatsLoaded=function(){delete WinterBash.hatsLoaded,e()},$.ajax({"url":WinterBash.STATIC_CONTENT_ROOT+"js/theactualhats.js?v="+WinterBash.IMAGE_CACHE_BREAKER,"cache":!0,"dataType":"script"})}function n(){$(document).on("userhovershowing",function(e,t){$(t).find(".hat").css("opacity",0)}),$(document).on("userhovershown",function(e){var t=$(e.target);S(t.find(".um-gravatar"),!0),t.closest("#user-menu").parent().css("overflow","visible")}),$(document).on("userhoverremoved",function(e){$(e.target).find(".hat").css("opacity",1)})}function a(){try{var e=[];for(var t in localStorage)/^(?:wb14:|wb15:)/.test(t)&&e.push(t);for(var n=0;n<e.length;n++)localStorage.removeItem(e[n])}catch(a){}}function o(){var e=$("<a href='#' class='topbar-icon yes-hover icon-winterbash'><span class='wb-unread-count'></span></a>").appendTo(".topbar .network-items"),t=e.offset().left+36;t>$(".topbar .topbar-links").offset().left&&e.css({"position":"relative","left":-(t-$(".js-site-switcher-button").offset().left)})}function r(e){e&&e[0]&&e[0].isNew&&$.ajax({"url":"/winter-bash/acknowledge-inbox","type":"POST","data":{"fkey":StackExchange.options.user.fkey}})}function i(e){o(),e&&f().done(v);var t;$(".wb-link, .wb-unread-count, .icon-winterbash").click(function(n){if(!$(this).is(".icon-winterbash.wb-open")){var a=$(".wb-unread-count").is(":visible");nt.set(StackExchange.options.user.accountId,0),v(0);var o,i;e?(o=function(e,n){$("<div class='wb-footer'><a href='#' id='wb-hate'></a></div>").appendTo(e).find("a").text(Y("hate")).attr("title",Y("optout")),e.find("#wb-hate").click(function(t){$(this).html("<em>"+J("optingout")+"</em>"),$.ajax({"url":"/winter-bash/opt-out","type":"POST","data":{"promoHost":M,"fkey":StackExchange.options.user.fkey},"dataType":"json","success":function(){tt.setSync(StackExchange.options.user.accountId,!1),window.location.reload()},"error":function(){StackExchange.helpers.showErrorPopup(e,Y("optouterror"))}}),A("winterbash.opt_out",{}),t.preventDefault()}),t?(w(e.find("ul"),t),n&&n(e)):(e.find(".modal-content").addSpinner(),$.ajax({"url":"//"+M+"/api/inbox","crossDomain":!0,"data":{"accountId":StackExchange.options.user.accountId},"dataType":"jsonp","success":function(a){t=a,e.removeSpinner(),r(a),w(e.find("ul"),a),n&&n(e)}}))},i=function(e){e.find(".wb-inbox-item.wb-new").removeClass("wb-new")}):(o=function(e,t){var n=$(["<p>",K("invite1",{"StackExchange":'<a href="//stackexchange.com" target="_blank">Stack Exchange </a>'}),"</p>","<p><strong>",K("invite2",{"WinterBash":'<a href="//'+M+'" target="_blank">Winter Bash</a>'}),"</strong></p>",'<button id="wb-join"></button>'].join(""));e.find(".items").replaceWith(n),e.find("#wb-join").text(Y("love")).attr("title",Y("join")).click(function(t){$(this).attr("disabled",!0).val(Y("joining")),$.ajax({"url":"/winter-bash/opt-in","type":"POST","data":{"promoHost":M,"fkey":StackExchange.options.user.fkey},"dataType":"json","success":function(){tt.setSync(StackExchange.options.user.accountId,!0),window.location.reload()},"error":function(){StackExchange.helpers.showErrorPopup(e,Y("joinerror"))}}),A("winterbash.opt_in",{}),t.preventDefault()}),t&&t(n)},i=function(){}),A("winterbash.inbox_show",{"has_number":a}),s("Winter Bash","wb-inbox-popup",o,i),n.preventDefault()}})}function s(e,t,n){function a(e){27==e.which&&r()}function o(e){i.find(e.target).length||r(),s.is(e.target)&&e.preventDefault()}function r(){i.remove(),$(document).off("keyup",a),$(document).off("click",o),$(".topbar .topbar-icon:not(.icon-winterbash)").off("click",".topbar-icon",o),s.removeClass("wb-open")}var i=$("<div class='topbar-dialog wb-inbox-dialog'><div class='header'><h3><a href='//"+M+"'>Winter Bash</a></h3></div><div class='modal-content'><ul class='items' /></div></div>");$(".js-topbar-dialog-corral").append(i);var s=$(".topbar .icon-winterbash").addClass("wb-open"),c=s.outerHeight(),u=s.offset().left-i.offset().left;i.css({"top":c,"left":u}),setTimeout(function(){$(document).click(o),$(".topbar .topbar-icon:not(.icon-winterbash)").on("click",o),$(document).keyup(a)},0),n(i)}function c(e,t,n,a,o,r){function i(e){h.find(".wb-popup-content").html(e)}function s(e){27==e.which&&c()}function c(){u.fadeOut("fast"),o?h.fadeOut("fast",function(){h.remove()}):h.fadeOut("fast"),u.unbind("click",c),$(document).unbind("keyup",s),h.find(".wb-popup-close").unbind("click",c),r&&r()}var u=$(".wb-overlay"),h=$("#"+t);u.length||(u=$('<div class="wb-overlay"></div>').css("height",$("body").height()).appendTo("body")),h.length||(h=$(['<div class="wb-popup" id="'+t+'">','<div class="wb-popup-header">','<div class="wb-popup-title">',e,"</div>",'<div class="wb-popup-close"></div>',"</div>",'<div class="wb-popup-content">',"<em>"+Y("loading")+"</em>","</div>","</div>"].join("")).appendTo("body"),h.find(".wb-popup-close").click(c)),u.fadeIn("fast"),h.center().fadeIn("fast"),X[t]?a(h):n(h,function(e){i(e),h.center(),o||(X[t]=!0)}),u.click(c),$(document).keyup(s)}function u(){if(Z)return Z;Z=$.Deferred();var e,t=$('<link rel="stylesheet" type="text/css" href="'+P+'css/wb-include.css?22" />').appendTo("head");t.on("load",function(){Z.resolve(),e&&clearInterval(e)});var e=setInterval(function(){var t=$("<div class='wb-popup' />").appendTo("body");"none"===t.css("display")&&(clearInterval(e),e=null,Z.resolve()),t.remove()},1e3);return Z}function h(){if(!et){et=!0;var e=Generator([/\/users\/filter/i,/\/posts\/\d+\/edit-submit/i,/\/posts\/\d+\/ajax-load-mini/i,/\/|posts\/ajax-load-realtime/i]);$(document).ajaxComplete(function(t,n,a){if(a){e.any(function(e){return e.test(a.url)})&&V.trigger();for(var o=0;o<Q.length;o++)Q[o].call(null,a.url)}})}}function l(){var e;return StackExchange.options.user.isAnonymous?(e=$.Deferred(),e.resolve(!1),e.promise()):tt.get(StackExchange.options.user.accountId)}function d(e,t){var n=$.Deferred();return $.ajax({"url":"//"+M+"/api/is-participating","crossDomain":!0,"data":{"accountId":e,"host":R},"dataType":"jsonp","cache":t,"jsonpCallback":"wbParticipating"+e}).done(function(e){n.resolve(e.isParticipating)}),n.promise()}function f(){var e;return StackExchange.options.user.isAnonymous?(e=$.Deferred(),e.resolve(0),e.promise()):nt.get(StackExchange.options.user.accountId)}function p(e,t){var n=$.Deferred();return $.ajax({"url":"//"+M+"/api/unread-count","crossDomain":!0,"data":{"accountId":e},"dataType":"jsonp","cache":t,"jsonpCallback":"wbUnread"+e}).done(function(e){n.resolve(e.unreadCount)}),n.promise()}function v(e){var t=$(".wb-unread-count");return 0>=e?(t.hide(),void 0):(e>99&&(e=99),t.text(e).css("display",t.parent().hasClass("topbar-icon")?"inline-block":"block"),void 0)}function g(e,t){var n=e.match(at);return n?'<div class="site-icon favicon favicon-'+n[1]+'" title="'+t+'" />':'<img class="site-icon" src="'+e.replace(/^http:/,"")+'" title="'+t+'" />'}function w(e,t){if(t&&0!=t.length)e.empty(),$.each(t,function(){var t=K("hatonsite",{"hatName":this.hatName,"siteName":this.siteName}),n=$(['<li class="wb-inbox-item',this.isNew?" wb-new":"",'" >','<a href="',this.link,'">',g(this.siteFaviconUrl,t),'<div class="wb-hat-holder" title="',t,'"/>',"<p>",K("youearned",{"hatName":this.hatName,"siteName":this.siteName}),"</p>","</a>","</li>"].join(""));n.find(".wb-hat-holder").append(WinterBash.hats.getHatDivToFitInside(this.hatId,16,16,P)),e.append(n),this.isNew=!1});else{e.empty();var n=$(['<li class="wb-inbox-item',this.isNew?" wb-new":"",'" >','<a href="//',M,'">','<img class="site-icon" src="',P,'/favicon.ico" />',"<p>"+Y("nohats")+"</p>","</a>","</li>"].join(""));e.append(n)}}function m(){function e(e,t){var n=parseInt(localStorage.getItem(e),10);return isNaN(n)?t||0:n}function t(){o&&(clearTimeout(o),o=null);var t=(new Date).getTime();e(L+"lastblur")||localStorage.setItem(L+"lastblur",t)}function n(){o=setTimeout(function(){var t=(new Date).getTime(),n=e(L+"lastblur",t),a=e(L+"awaytime")+t-n;localStorage.setItem(L+"awaytime",a),localStorage.removeItem(L+"lastblur")},10)}if(G){var a=StackExchange.options.user.userId;if(a){var o;(!document.hasFocus||document.hasFocus())&&n(),$(window).focus(n).blur(t).on("unload",function(){document.hasFocus&&document.hasFocus()&&t()}),e(L+"awaytime")>1e4&&(ot.remove(a),localStorage.removeItem(L+"awaytime"),localStorage.removeItem(L+"lastblur"))}}}function b(e,t){var n=rt[e];return n||(n=rt[e]=$.Deferred()),st.trigger(t),n}function y(e,t,n){var a=ot.get(e).done(function(e){e&&t(e)});n&&a.fail(n)}function k(e){var t=null;return e.replace(/users\/(-?\d+)/,function(e,n){t=parseInt(n,10)}),t}function x(e){for(var t=[],n={},a=0;a<e.length;a++){var o=e[a];if(100>o)n[o]=WinterBash.hats.getHatTooltip(o);else{if(G){var r=localStorage.getItem(L+"hat-name2-"+o);if(r){n[o]=r;continue}}t.push(o)}}var i=$.Deferred();return t.length?($.ajax({"url":"//"+M+"/api/hat-names","crossDomain":!0,"dataType":"jsonp","data":{"hatids":t.join(";")},"cache":!0,"jsonpCallback":("wbHatNames"+Generator(t).reduce(function(e,t){return e+t},0)).replace(/-/g,"_")}).done(function(e){for(var t in e)e.hasOwnProperty(t)&&(G&&localStorage.setItem(L+"hat-name2-"+t,e[t]),n[t]=e[t]);i.resolve(n)}),i.promise()):i.resolve(n).promise()}function S(e,t,n,a,o){var r="a[href*='/users/']",i=e.is(r)?e.attr("href"):e.find(r).attr("href");if(!i)return o(),void 0;var s=k(i);y(s,function(r){a&&a(e),WinterBash.hats.addHatToGravatar(r.i,r.x,r.y,r.s,r.r,e,t).done(function(e){n&&n(e)}).fail(o)},o)}function T(e){e.find(".hat").remove()}function E(e){function t(){a--,!a&&o&&$(".wb-garbage-hat").remove()}function n(n,o,i){if(!i||i===r){e&&(n+=":not(.wb-hat-checked)");var s=$(n);a+=s.length,s.each(function(){S($(this).addClass("wb-hat-checked"),o,t,T,t)})}}e=e===!0;var a=0,o=!1;e||$(".hat:not(.wb-no-rehattify)").addClass("wb-garbage-hat");var r=location.pathname.match(/^\/(\w*)/)[1].toLowerCase();n(".user-gravatar32",!1),n(".profile-me",!1),n(".user-gravatar48",!0),n("#large-user-info:visible .user-header-left .gravatar",!0,"users"),n("#small-user-info:visible .gravatar",!0,"users"),n("body.review-page .dashboard-activity .dashboard-user",!1,"review"),n("#mainbar-full:not(.account-info) #avatar-card .avatar > a",!0,"users"),n(".user-gravatar-mini",!0,"users"),n(".contributor-gravatar > a",!1,"documentation"),n(".topic-revision-list .revision-user",!1,"documentation"),n(".proposed-change .creation-user .gravatar",!1,"documentation"),o=!0,a||$(".wb-garbage-hat").remove()}function I(e,t){return $.ajax({"url":"//"+M+"/api/user-hats","crossDomain":!0,"data":{"userId":e,"host":R},"dataType":"jsonp","cache":t,"jsonpCallback":("wpUserHats"+e).replace(/-/g,"_")})}function j(){function e(){function e(){if(n.test(location.hash)){var e=document.title;o?location.hash="":history.back(),document.title=e}}var a=StackExchange.options.user.userId==t?Y("yourhats"):Y("somebodysHats"),r=function(e,n){ct.get(t).done(function(e){var a=$("<div></div>");D(a,t,e),n(a)})},i=function(){};c(a,"wb-hat-rack",r,i,!0,e)}var t=parseInt(location.pathname.replace(/^\/users\/(-?\d+)\/.*$/,"$1"),10)||null;if(t){var n=/^#winter-bash(?:-\d+)?$/,a=location.hash,o=!1;U||($(window).on("hashchange",function(){var t=location.hash;!n.test(a)&&n.test(t)?e():n.test(a)&&!n.test(t)&&$("#wb-hat-rack .wb-popup-close").click(),a=t}),n.test(a)&&(e(),o=!0,A("winterbash.open_hat_rack",{"via_click":!1,"is_own":t===StackExchange.options.user.userId}))),$(".toggle-summary").click(V.trigger),$.ajax({"url":"//"+M+"/api/hat-count","crossDomain":!0,"data":{"userId":t,"host":R},"dataType":"jsonp","success":function(e){if(e){$(".user-header-left table tbody.user-profile-stats, .user-header-left table tbody:last").eq(0).append(["<tr>","<th></th>","<td>hats</td>","<td>",'<a href="#winter-bash" id="wb-hat-count">',e," <span style=\"display: inline-block; width: 14px; height: 15px; background: url('",P,"img/sprite-hat-picker.png?1') -839px -47px; vertical-align: top;\"></span>","</a>","</td>","</tr>"].join(""));var n=$("#user-card .user-links").eq(0);if(n.length){var a,o,r=n.find(">ul").eq(0);r.length?(n=r,a="<li>",o="</li>"):(a='<div class="row">&nbsp;</div><div class="row"><div class="col-6">',o="</div></div>"),n.append([a,'<span id="wb-newprofile-snowflake" />',' <a href="#winter-bash" id="wb-hat-count">',e>1?K("nhats",{"n":e}):J("onehat"),"</a>",o].join(""))}var i=$("#top-cards .badges-card, #top-cards .tag-badges-card");if(i.length){var s=function(){i.append('<a href="#winter-bash" id="wb-hat-count" class="wb-activitytab-hat" title="'+(e>1?K("nhats",{"n":e}):J("onehat"))+'"><span>'+e+"</span></a>");var n=$(".additional-links .mod-links");if(n.length){var a=$("#wb-hat-count"),o=a.offset(),r=n.offset();o.top<r.top+n.height()&&n.css("margin-right",parseFloat(n.css("margin-right"))+r.left+n.width()-o.left),a.on("click",function(){A("winterbash.open_hat_rack",{"via_click":!0,"is_own":t===StackExchange.options.user.userId})})}};s(),Q.push(function(e){e.indexOf("users/activity/badge-card/pick-next-badge")>=0&&setTimeout(function(){$("#wb-hat-count").length||(i=$("#top-cards .badges-card, #top-cards .tag-badges-card"),s())},0)})}U?$("#wb-hat-count").attr("href","//"+R+location.pathname+"#winter-bash"):$("#user-info-container, #avatar-card").on("click",".gravatar > a:first-child, .avatar > a:first-child",function(e){"change-picture"!==e.target.id&&(location.hash="#winter-bash",A("winterbash.open_hat_rack",{"via_click":!0,"is_own":t===StackExchange.options.user.userId}),e.preventDefault())})}}})}}function B(e){var t;return t=/^touch/.test(e.type)?e.originalEvent.touches[0]:e,{"x":t.pageX,"y":t.pageY}}function C(e,t,n,a,o){e.addClass("wb-draggable");var r,i,s,c,u=!1;if(o=o||1,t){var h=t;t=function(){var e=h();return{"x":e.x,"y":e.y}}}else t=function(){return{"x":0,"y":0}};e.on("mousedown touchstart",function(n){u=!0;var a=B(n);return r=Math.round(a.x),i=Math.round(a.y),s=t(),c={"x":s.x,"y":s.y},e.addClass("wb-dragging"),!1}).click(function(){return!1});var l=function(){return u?(u=!1,e.removeClass("wb-dragging"),a&&a(c.x,c.y),!1):!0},d=function(t){if(!e.parent().length)return $(document).unbind("mousemove touchmove",d),$(document).unbind("mouseup touchend",l),$(document).unbind("mouseout touchleave touchcancel",f),!0;if(!u)return!0;var a=B(t);return c={"x":s.x+(Math.round(a.x)-r)*o,"y":s.y+(Math.round(a.y)-i)*o},n&&n(c.x,c.y),!1},f=function(t){return u?t.relatedTarget?!0:(u=!1,e.removeClass("wb-dragging"),a(s.x,r.y),!1):!0};$(document).on("mouseup touchend",l).on("mousemove touchmove",d).on("mouseout touchleave touchcancel",f)}function W(e,t,n,a,o){var r=o*Math.PI/180,i=e[n]-t[n],s=e[a]-t[a];e[n]=i*Math.cos(r)-s*Math.sin(r)+t[n],e[a]=i*Math.sin(r)+s*Math.cos(r)+t[a]}function _(e,t,n,a){function o(){$("#wb-take-off").text($("#wb-only-here").prop("checked")?Y("takeoffhere"):Y("takeoffeverywhere"))}var r,i=$("<div class='wb-hat-details'/>").prependTo(e);if(n){var s=$("<a class='wb-hat-details-avatar'/>").attr("href","/users/"+t).click(function(e){e.preventDefault()}).appendTo(i),c=$(".user-header-left .gravatar, #avatar-card .avatar, .user-gravatar-mini .gravatar-wrapper-32").find("img:last").attr("src");r=$("<img width=128 height=128/>").attr("src",c.replace(/([?&])s=\d+/,"$1s=128")).appendTo(s)}else var u=$("<div id='wb-hat-details-display'></div>").text(Y("hatdetails")).appendTo(i);var h,l,d,f,p=$("<div id='wb-hat-details-info' />").appendTo(i),v={"element":i,"setHat":function(e,a){if(!e)return n&&f.hide(),void 0;n&&f.show();var o=$("#wb-show-handle").prop("checked");if(p.empty().addSpinner(),H(t,e,function(e){if($("<h3 />").text(e.hat_name).appendTo(p.empty()),$("<p class='wb-hat-detail-description' />").text(e.hat_description).appendTo(p),n){{var a=$("<p />").appendTo(p);$("<input type='checkbox' id='wb-show-handle' />").prop("checked",o||!1).appendTo(a).on("change",function(){var e=$(this).prop("checked");e?$("#wb-handles-container").show():$("#wb-handles-container").hide()}).trigger("change")}$("<label for='wb-show-handle'></label> ").text(Y("showcontrols")).appendTo(a)}var r;if(StackExchange.options.user.userId==t)r=J("youearnedon");else{var i,s=$("#user-displayname, .user-card-name, .mini-avatar > .name")[0];if(s){for(var c=s;c&&3!==c.nodeType;)c=c.childNodes[0];c&&3===c.nodeType&&(i=$.trim(c.nodeValue))}r=i?K("nameearnedon",{"username":i}):J("userearnedon")}p.append($("<span />").html(r));var u=$("<span />"),h=$("<p />").appendTo(p);if(Generator(e.sites).take(7).forEach(function(e){var t=u.html(e.site_name).text();$(g(e.favicon,"")).addClass("wb-favicon").attr("title",t).appendTo(h)}),e.total_sites>7){var l=e.total_sites-7;h.append("<br/><span>"+(l>1?K("andmoresites",{"n":l}):J("andonesite")))}}),!n){var c=WinterBash.hats.getHatDivToFitInside(e,128,128,P).appendTo(u.empty());return c.css("margin-top",(128-c.height())/2|0),void 0}h=e,l={"x":a.x,"y":a.y,"s":a.s,"r":a.r},a={"x":a.x,"y":a.y,"s":a.s,"r":a.r},WinterBash.hats.ensureLegalShift(e,a),d={"x":a.x,"y":a.y,"s":a.s,"r":a.r},i.find(".hat").remove(),$("#wb-handles-container").remove(),WinterBash.hats.addHatToGravatar(e,a.x,a.y,a.s,a.r,s,!0).done(function(t,n){function o(){var e={"x":(244+d.x+i.x)/4,"y":(104+d.y+i.y)/4};c.css({"left":e.x,"top":e.y+45}),f=Math.min(260,g.top+e.y-60-20,g.left+e.x-60-20);var t=Math.log(d.s/100)/Math.log(2.5),n=Math.round((t+1)/2*f+60);l={"x":0,"y":-n},W(l,{"x":0,"y":0},"x","y",d.r),u.css({"left":-20+l.x,"top":-20+l.y}),h.css({"left":n-20+40});var a="rotate("+(d.r-90)+"deg)";return p.css({"width":n-20,"transform":a,"-ms-transform":a,"-webkit-transform":a}),v.css("width",n-20+40),l}var i=WinterBash.hats.getHatShift(e);t.addClass("wb-no-rehattify");var c=$("<div id='wb-handles-container' />").appendTo(s),u=$("<div id='wb-rotscale-handle'/>").appendTo(c),h=$("<div id='wb-move-handle'/>").appendTo(c);$("#wb-show-handle").prop("checked")||c.hide();var l,f,p=$("<div id='wb-rotscale-line' />").appendTo(c),v=$("<div id='wb-move-line' />").appendTo(c),g=r.offset();o(),C(u,function(){return l},function(t,r){var i=Math.sqrt(t*t+r*r);a.s=Math.round(100*Math.pow(2.5,2*(i-60)/f-1)),a.r=90+Math.round(0===t?r>=0?90:-90:180*Math.atan(r/t)/Math.PI),0>t&&(a.r+=180),a.r>180&&(a.r-=360),d={"x":a.x,"y":a.y,"s":a.s,"r":a.r},WinterBash.hats.ensureLegalShift(e,d,!1,!0),n(d.x,d.y,d.s,d.r),o()},function(){a={"x":d.x,"y":d.y,"s":d.s,"r":d.r}},1),C(t.add(h).add(p).add(v),function(){return d},function(t,r){a.x=Math.round(t),a.y=Math.round(r),d={"x":a.x,"y":a.y,"s":a.s,"r":a.r},WinterBash.hats.ensureLegalShift(e,d,!0,!1),n(d.x,d.y,d.s,d.r),o()},function(){a={"x":d.x,"y":d.y,"s":d.s,"r":d.r}},4)})}};if(p.on("click","#wb-show-handle",function(){A("winterbash.toggle_control_handles",{"enabled":$("#wb-show-handle").prop("checked")})}),n){if(f=$("<div class='wb-controls' />").hide().appendTo(i),a){var w=$("<input type='checkbox' id='wb-only-here' />").appendTo(f).on("change",function(){var e=$(this).prop("checked");o(),G&&(e?localStorage.setItem(L+"onlyhere","1"):localStorage.removeItem(L+"onlyhere"))});G&&(w.prop("checked","1"===localStorage.getItem(L+"onlyhere")),setTimeout(o,0)),$("<label for='wb-only-here'></label> ").text(Y("onlyhere")).appendTo(f)}{$("<button></button>").text(Y("wearhat")).appendTo(f)}e.on("click","#wb-take-off, .wb-controls button",function(n){n.preventDefault();var o,r=d||l,i="wb-take-off"!==this.id,s=a&&!w.prop("checked"),c=t===StackExchange.options.user.userId;o=i?{"hatId":h,"fkey":StackExchange.options.user.fkey,"x":r.x,"y":r.y,"s":r.s,"r":r.r,"everywhere":s,"community":-1===t}:{"fkey":StackExchange.options.user.fkey,"everywhere":s,"community":-1===t};var u=$(this),f=u.text();u.empty().addSpinner().prop("disabled",!0),$.ajax({"url":i?"/winter-bash/wear":"/winter-bash/take-off","type":"POST","data":o,"dataType":"json","success":function(){e.find(".wb-wearing").removeClass("wb-wearing"),i?($("#wb-hat-"+h).addClass("wb-wearing"),$(".wb-popup-close").click(),ot.set(t,{"i":h,"x":r.x,"y":r.y,"s":r.s,"r":r.r})):($(".wb-popup-close").click(),ot.set(t,{"i":0,"x":0,"y":0,"s":100,"r":0})),E()},"error":function(t){var n;n=409===t.status?t.responseText:Y("changeerror"),StackExchange.helpers.showErrorPopup(e,n),u.text(f).prop("disabled",!1)}}),i?A("winterbash.wear_hat",{"is_own":c,"everywhere":s,"hat_id":h,"default_rotation":0===r.r,"default_scale":100===r.s,"default_position":0===r.x&&0===r.y}):A("winterbash.take_off_hat",{"is_own":c,"everywhere":s})})}return v}function N(e,t,n,a,o){var r;e.find("#wb-hat-"+n.i).addClass("wb-wearing"),e.on("click",".wb-outer",function(){e.find(".wb-selected").removeClass("wb-selected"),$(this).addClass("wb-selected"),r=parseInt(this.id.substring("wb-hat-".length),10);var t={"x":n.x,"y":n.y,"s":n.s,"r":n.r};a.setHat(r,t)}),setTimeout(function(){e.find(".wb-selected").removeClass("wb-selected"),$("#wb-hat-"+(o||n.i)).addClass("wb-selected");var t={"x":n.x,"y":n.y,"s":n.s,"r":n.r};a.setHat(o||n.i,t)},0)}function D(e,t,n){for(var a,o,r,i,s=[],c=$("<div class='wb-rack' />").appendTo(e),u=0;u<n.length;u++){o=n[u],a=o[0],s.push(a),r=$('<div class="wb-outer" id="wb-hat-'+a+'"></div>');try{i=WinterBash.hats.getHatDivToFitInside(a,40,48,P)}catch(h){continue}i.css({"margin-left":"auto","margin-right":"auto","margin-top":(50-i.height())/2+"px"}),r.append(i),o[2]&&r.addClass("wb-earned-here"),c.append(r),(u+1)%9==0&&u+1<n.length&&c.append('<div class="wb-separator"></div>')}x(s).done(function(t){for(u=0;u<s.length;u++)$("#wb-hat-"+s[u],e).attr("title",t[s[u]])}),c.append('<div class="wb-bottom" style="left: 242px"><a class="dno" href="#" id="wb-take-off">'+Y("takeoffeverywhere")+"</a></div>"),c.append('<div class="wb-bottom" style="right: 20px"><a href="//'+M+'" target="_blank">Winter Bash &raquo;</a></div>');var l=StackExchange.options.user.userId===t,d=StackExchange.options.user.isModerator&&-1===t,f=_(e,t,l||d,l);y(t,function(n){var a,o=/^#winter-bash-(\d+)$/.exec(location.hash);o&&(location.replace(location.href.replace(/-\d+$/,"")),a=parseInt(o[1],10),c.find("#wb-hat-"+a).length||(a=null)),(l||d)&&n.i&&(c.find("#wb-take-off").removeClass("dno"),d&&c.find("#wb-take-off").text(Y("takeoffCU"))),N(e,t,n,f,a)})}function H(e,t,n){ut.get(e+"="+t).done(n)}function q(e,t){var n=e.split("=");return $.ajax({"url":"//"+M+"/api/user-hat-details/","crossDomain":!0,"dataType":"jsonp","jsonpCallback":"wbUHDetails"+e.replace(/[=-]/g,"_"),"cache":t,"data":{"userid":n[0],"hatid":n[1],"host":R,"lang":StackExchange.options.locale}})}function A(e,t){StackExchange.using("gps",function(){StackExchange.gps.track(e,t)})}function O(e,t,n,a){function o(){v.setItem(t,JSON.stringify(s(!0))),m=[]}function r(e){for(var t=m.length,n=0;t>n;n++){var a=m[n];1===a.length?delete e[a[0]]:e[a[0]]=a[1]}}function i(e){var t={},n=(new Date).getTime()-w;for(var a in e)e.hasOwnProperty(a)&&e[a].t>=n&&(t[a]=e[a]);return t}function s(e){if(!p||e){var n=v.getItem(t);n?(p=i($.parseJSON(n)),r(p)):(p={},r(p))}return p}function c(e){return function(t){h(e,t)}}function u(t){var n=s();if(!(n&&t in n))return e(t).done(c(t));var a,o=n[t],r=(new Date).getTime()-o.t;return r>g&&(a=e(t).done(c(t))),w>=r?$.Deferred().resolve(o.v).promise():a}function h(e,t){var n=s(),a={"t":(new Date).getTime(),"v":t};n[e]=a,m.push([e,a]),k.trigger()}function l(e,t){h(e,t),k.cancel(),o()}function d(e){var t=s();if(t&&e in t){var n=t[e],a=(new Date).getTime()-n.t;return w>=a?n.v:void 0}}function f(e){var t=s();t&&(delete t[e],m.push([e]))}var p,v,g=1e3*n,w=1e3*a,m=[];if(G)v=localStorage,$(window).on("storage",function(e){e.originalEvent.key===t&&(p=null)});else{var b=function(){return null};v={"getItem":b,"setItem":b};var y=e;e=function(e){return y(e,!0)}}var k=StackExchange.helpers.DelayedReaction(o);return{"get":u,"set":h,"setSync":l,"getIfAvailable":d,"remove":f}}!function(e){var t;t=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=e.length,a=0;n>a;a++)if(a in e&&e[a]===t)return a;return-1};var n={},a=function(e){return this instanceof a?(this.forEach="function"==typeof e?i(e):e.constructor===Array?s(e):c(e),void 0):new a(e)},o=function(){throw n},r=function(e){this.message=e,this.name="IterationError"};r.prototype=Error.prototype;var i=function(e){return function(t,i){var s=!1,c=0,u=function(e){if(s)throw new r("yield after end of iteration");return e=t.call(i,e,c,o),c++,e},h=function(e){e=e instanceof a?e:new a(e),e.forEach(function(e){u(e)})};try{e(u,h,o)}catch(l){if(l!==n)throw l}finally{s=!0}}},s=function(e){return i(function(t){for(var n=e.length,a=0;n>a;a++)a in e&&t(e[a])})},c=function(e){return i(function(t){for(var n in e)e.hasOwnProperty(n)&&t([n,e[n]])})},u=function(e){return"string"==typeof e?function(t){return t[e]}:e};a.prototype={"toArray":function(){var e=[];return this.forEach(function(t){e.push(t)}),e},"filter":function(e,t){var n=this;return e=u(e),new a(function(a){n.forEach(function(n){e.call(t,n)&&a(n)})})},"take":function(e){var t=this;return new a(function(n){t.forEach(function(t,a,o){a>=e&&o(),n(t)})})},"skip":function(e){var t=this;return new a(function(n){t.forEach(function(t,a){a>=e&&n(t)})})},"map":function(e,t){var n=this;return e=u(e),new a(function(a){n.forEach(function(n){a(e.call(t,n))})})},"zipWithArray":function(e,t){"undefined"==typeof t&&(t=function(e,t){return[e,t]});var n=this;return new a(function(a){var o=e.length,r=0;n.forEach(function(n,i,s){for(;!(i+r in e)&&o>i+r;)r++;i+r>=o&&s(),a(t(n,e[i+r]))})})},"reduce":function(e,t){var n,a;return 2>arguments.length?n=!0:(n=!1,a=t),this.forEach(function(t){n?(a=t,n=!1):a=e(a,t)}),a},"and":function(e){var t=this;return new a(function(n,a){a(t),a(e)})},"takeWhile":function(e){var t=this;return e=u(e),new a(function(n){t.forEach(function(t,a,o){e(t)?n(t):o()})})},"skipWhile":function(e){var t=this;return e=u(e),new a(function(n){var a=!0;t.forEach(function(t){(a=a&&e(t))||n(t)})})},"all":function(e){var t=!0;return e=u(e),this.forEach(function(n,a,o){(e?e(n):n)||(t=!1,o())}),t},"any":function(e){var t=!1;return e=u(e),this.forEach(function(n,a,o){(e?e(n):n)&&(t=!0,o())}),t},"first":function(){var e;return this.forEach(function(t,n,a){e=t,a()}),e},"groupBy":function(e){var n=this;return e=u(e),new a(function(o,r){var i=[],s=[];n.forEach(function(n){var a=e(n),o=t(i,a);-1===o?(i.push(a),s.push([n])):s[o].push(n)}),r(new a(i).zipWithArray(s,function(e,t){var n=new a(t);return n.key=e,n}))})},"evaluated":function(){return new a(this.toArray())},"except":function(e){return this.filter(function(t){return t!==e})},"sortBy":function(e){var t=this;return e=u(e),new a(function(n){var o=t.toArray(),r=l(0,o.length).toArray();r.sort(function(t,n){var a=e(o[t]),r=e(o[n]);if(typeof a==typeof r){if(a===r)return n>t?-1:1;if(r>a)return-1;if(a>r)return 1}throw new TypeError("cannot compare "+a+" and "+r)}),new a(r).forEach(function(e){n(o[e])})})},"count":function(){var e=0;return this.forEach(function(){e++}),e}};var h=function(e,t){var n=e;return"undefined"==typeof t&&(t=1),new a(function(e){for(;;)e(n),n+=t})},l=function(e,t){return h(e,1).take(t)},d=e.Generator;e.Generator=a,a.BreakIteration=n,a.Count=h,a.Range=l,a.IterationError=r,a.noConflict=function(){return e.Generator=d,a}}(this),Generator=Generator.noConflict();var M,P,G=!1,U=!1,R=window.location.hostname.toLowerCase();/^meta\./.test(R)&&"meta.stackexchange.com"!==R&&(U=!0,R=R.substring(5));var L="wb16:";a();try{var F="hello "+Math.random();window.localStorage.setItem(L+"test",F),localStorage.getItem(L+"test")===F&&(G=!0),window.localStorage.removeItem(L+"test")}catch(z){G=!1}var Y,Z,J=function(e,t){return $("<span/>").text(Y(e,t)).html()},K=function(e,t){return J(e,t).replace(/\${(\w+)}/g,function(e,n){return t[n]})},V=StackExchange.helpers.DelayedReaction(E,200,{"sliding":!0}),X={},Q=[],et=!1,tt=O(d,L+"isparticipating",300,600),nt=O(p,L+"unreadcount",300,600),at=/\/sites\/([^/]+)\/img\//i,ot=O(b,L+"wearing",300,600),rt={},it=50,st=StackExchange.helpers.DelayedReaction(function(e){var t=[],n=rt,a={},o=0;for(var r in n)n.hasOwnProperty(r)&&(it>o?t.push(parseInt(r,10)):a[r]=n[r],o++);if(o){rt=a;var i=Math.abs(Generator(t).reduce(function(e,t){return e+t},0)),s="//"+M+"/api/current-hats";$.ajax(s,{"crossDomain":!0,"dataType":"jsonp","data":{"userids":t.join(";"),"host":R},"cache":e,"jsonpCallback":"winterBashCurrentHats"+i}).done(function(e){for(var a=0;a<t.length;a++){r=t[a];var i=e[r]||0;n[r].resolve(i)}o>it&&setTimeout(st.trigger,1e3)})}},100),ct=O(I,L+"alluserhats",60,90),ut=O(q,L+"user-hat-details",300,600);return{"init":e,"draggable":C}}(),window.WinterBash.text={},window.WinterBash.text.en={"hate":"I hate hats","optout":"opt out of Winter Bash","optingout":"opting out…","optouterror":"An error occurred while opting out - please try again.","invite1":"${StackExchange} invites you to celebrate the end of a great year … with HATS!","invite2":"To participate in ${WinterBash}, simply click the button below!","love":"I Love Hats!","join":"Join Winter Bash!","joining":"Joining…","joinerror":"An error occurred while joining - please try again.","loading":"loading…","nohats":"You have not earned any hats yet.","hatonsite":"${hatName} on ${siteName}","youearned":"You earned ${hatName} on ${siteName}!","yourhats":"Your Hats","somebodysHats":"Hats","onehat":"1 hat","nhats":"${n} hats","hatdetails":"Click a hat to view its details","showcontrols":"show controls","youearnedon":"You earned this hat on:","nameearnedon":"${username} earned this hat on:","userearnedon":"This user earned this hat on:","andonesite":"and one other site","andmoresites":"and ${n} other sites","onlyhere":"only on this site","takeoffeverywhere":"take off your hats everywhere","takeoffhere":"take off your hat on this site","takeoffCU":"take off Community's hat","wearhat":"Wear hat","changeerror":"An error occurred while changing the hat - please try again."},window.WinterBash.text.es={"hate":"Odio los sombreros","optout":"No participar en el Winter Bash","optingout":"no participar","optouterror":"Ocurrió un error al excluiste - intenta de nuevo por favor.","invite1":"${StackExchange} te invita a celebrar el fin del año, ¡con sombreros!","invite2":"Para participar en ${WinterBash}, ¡oprime el botón siguiente!","love":"¡Amo a los sombreros!","join":"¡Participa en Winter Bash!","joining":"Ingresando","joinerror":"Ocurrió un error al ingresar - intenta de nuevo por favor.","loading":"Cargando","nohats":"No has ganado ningún sombrero todavía.","hatonsite":"${hatName} en ${siteName}","youearned":"¡Ganaste ${hatName} en ${siteName}!","yourhats":"Tus Sombreros","somebodysHats":"Sombreros","onehat":"1 sombrero","nhats":"${n} sombreros","hatdetails":"Haz clic en un sombrero para ver sus detalles","showcontrols":"muestra controles","youearnedon":"Ganaste este sombrero en:","nameearnedon":"${username} gano este sombrero en:","userearnedon":"Este usuario gano este sombrero en:","andonesite":"y en otro sitio","andmoresites":"y en ${n} otros sitios","onlyhere":"solamente en este sitio","takeoffeverywhere":"remover por completo todos los sombreros","takeoffhere":"remover los sombreros en este sitio","takeoffCU":"remover los sombreros de Community","wearhat":"Usar el sombrero","changeerror":"Ocurrió un error al cambiar de sombrero - intenta de nuevo por favor."},window.WinterBash.text.ja={"hate":"帽子は嫌い","optout":"Winter Bashに参加しない","optingout":"処理中...","optouterror":"エラーが発生しました。もう一度お試しください。","invite1":"${StackExchange} で帽子を被りながら年末を楽しみませんか？","invite2":"下のボタンをクリックして、 ${WinterBash} に参加しましょう！","love":"帽子大好き！","join":"Winter Bashに参加する","joining":"処理中...","joinerror":"エラーが発生しました。もう一度お試しください。","loading":"読み込み中...","nohats":"まだ帽子を手に入れていません。","hatonsite":"${siteName} の ${hatName}","youearned":"${siteName} で ${hatName} を手に入れた！","yourhats":"あなたの帽子","somebodysHats":"このユーザーが持っている帽子","onehat":"1個","nhats":"${n}個","hatdetails":"詳細を確認するには帽子を選択してください","showcontrols":"コントロールを表示","youearnedon":"以下のサイトで獲得：","nameearnedon":"${username}がこの帽子を獲得したサイト：","userearnedon":"このユーザーがこの帽子を獲得したサイト：","andonesite":"他1サイト","andmoresites":"他${n}サイト","onlyhere":"このサイトだけに適用","takeoffeverywhere":"全てのサイトで帽子を被らない","takeoffhere":"このサイトでは帽子を被らない","takeoffCU":"Communityユーザーの帽子を取る","wearhat":"帽子を被る","changeerror":"エラーが発生しました。もう一度お試しください。"},window.WinterBash.text["pt-BR"]={"hate":"Eu odeio chapéus","optout":"não participar do Winter Bash","optingout":"saindo…","optouterror":"Ocorreu um erro - tente de novo.","invite1":"${StackExchange} te convida a celebrar mais um ótimo ano… com CHAPÉUS!","invite2":"Para participar do ${WinterBash}, clique no botão abaixo!","love":"Amo chapéus!","join":"Participe do Winter Bash!","joining":"entrando…","joinerror":"Ocorreu um erro - tente de novo","loading":"carregando…","nohats":"Sem chapéus até agora.","hatonsite":"${hatName} no ${siteName}","youearned":"Você ganhou ${hatName} no ${siteName}!","yourhats":"Seus chapéus","somebodysHats":"Chapéus","onehat":"1 chapéu","nhats":"${n} chapeús","hatdetails":"Clique num chapéu para ver mais detahes","showcontrols":"mostrar controles","youearnedon":"Você ganhou esse chapéu no:","nameearnedon":"${username} ganhou esse chapéu no:","userearnedon":"O usuário ganhou o chapéu no:","andonesite":"e em um outro site","andmoresites":"e em ${n} outros sites","onlyhere":"somente neste site","takeoffeverywhere":"não usar mais chapéus","takeoffhere":"não usar chapéus neste site","takeoffCU":"tirar chapéu do Comunidade","wearhat":"Usar chapéu","changeerror":"Ocorreu um erro ao mudar de chapéu - tente de novo."},window.WinterBash.text.ru={"hate":"Я ненавижу шляпы","optout":"исключить из «Winter Bash»","optingout":"исключение…","optouterror":"Во время исключения произошла ошибка. Пожалуйста, попробуйте снова.","invite1":"${StackExchange} приглашает Вас отпраздновать конец замечательного года ШЛЯПАМИ!","invite2":"Для принятия участия в «${WinterBash}», просто нажмите на кнопку ниже!","love":"Я люблю шляпы!","join":"Присоединиться к «Winter Bash»!","joining":"Присоединяемся…","joinerror":"Во время присоединения произошла ошибка. Пожалуйста, попробуйте еще раз.","loading":"Загрузка…","nohats":"Вы еще не заработали ни одной шляпы.","hatonsite":"${hatName} на ${siteName}","youearned":"Вы заработали ${hatName} на ${siteName}!","yourhats":"Ваши шляпы","somebodysHats":"Шляпы","onehat":"1 шляпа","nhats":function(e){return this._plural(e.n,"${n} шляпа","${n} шляпы","${n} шляп")
},"hatdetails":"Нажмите на шляпу, чтобы увидеть детали о ней","showcontrols":"показать инструменты","youearnedon":"Вы заработали эту шляпу на:","nameearnedon":"${username} заработал эту шляпу на:","userearnedon":"Участник заработал эту шляпу на:","andonesite":"еще один сайт","andmoresites":function(e){return this._plural(e.n,"еще ${n} сайт","еще ${n} сайта","еще ${n} сайтов")},"onlyhere":"только на этом сайте","takeoffeverywhere":"снять ваши шляпы везде","takeoffhere":"снять шляпу на этом сайте","takeoffCU":"снять шляпу Духа сообщества","wearhat":"Надеть шляпу","changeerror":"Во время изменения шляпы произошла ошибка. Пожалуйста, попробуйте снова.","_plural":function(e,t,n,a){if(e%=100,e>=5&&14>=e)return a;switch(e%10){case 1:return t;case 2:case 3:case 4:return n}return a}},WinterBash.text.getGetText=function(e){var t=WinterBash.text.en,n=WinterBash.text[e];return n||(StackExchange.debug.log("no WinterBash translation for locale "+e),n=t),function(a,o){var r=n[a];return"function"==typeof r&&(r=r.call(n,o)),r||StackExchange.debug.log("no WinterBash translation for string "+a+" in locale "+e)||t[a]||StackExchange.debug.log("unknown string resource "+a)||"UNKNOWN STRING"}};